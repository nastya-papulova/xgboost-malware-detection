import pandas as pd
import pickle
from sklearn.metrics import confusion_matrix, accuracy_score, precision_score, recall_score, f1_score


# создание нужных фичей
def add_cols(df):
    cols_list = model.get_booster().feature_names
    df[cols_list] = 0
    for index, row in df.iterrows():
        libs_list = row['libs'].split(',') if pd.notnull(row['libs']) else []  # Разбиваем строку на список
        for lib in cols_list:
            if lib in libs_list:
                df.at[index, lib] = 1
                libs_list.remove(lib)
            else:
                df.at[index, 'other'] = 1
    return df


def create_validation_txt(y_val, pred):
    with open('validation.txt', 'w') as f:
        tn, fp, fn, tp = confusion_matrix(y_val, pred).ravel()
        f.write(f"True positive: {tp}"
                f"\nFalse positive: {fp}"
                f"\nFalse negative: {fn}"
                f"\nTrue negative: {tn}"
                f"\nAccuracy: {accuracy_score(y_val, pred)}"
                f"\nPrecision: {precision_score(y_val, pred)}"
                f"\nRecall: {recall_score(y_val, pred)}"
                f"\nF1: {f1_score(y_val, pred)}")


with open('model.pkl', 'rb') as file:
    model = pickle.load(file)

val_df = pd.read_csv('val.tsv', sep='\t')
val_df = add_cols(val_df)

X_val = val_df.drop(['is_virus', 'filename', 'libs'], axis=1)
y_val = val_df.is_virus

pred = model.predict(X_val)
create_validation_txt(y_val, pred)
