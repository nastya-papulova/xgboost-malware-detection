import pandas as pd
import pickle
import shap
from validate import add_cols


def create_prediction_txt(predictions):
    with open('prediction.txt', 'w') as f:
        f.write("prediction\n")
        f.write("\n".join(map(str, predictions)))


def create_explain_txt(model_to_explain, df, predictions):
    explainer = shap.Explainer(model_to_explain)
    shap_values_all = explainer.shap_values(df.drop('libs', axis=1))
    shap_df = pd.DataFrame(shap_values_all, columns=df.drop('libs', axis=1).columns)
    shap_df['Predictions'] = predictions
    for index, row in shap_df.iterrows():
        libs = []
        if row['Predictions'] == 1:
            for col, value in row.items():
                if value > 0.1 and col != 'Predictions':
                    libs.append(col)
            with open('explain.txt', 'w') as f:
                f.write("\nДля строки № {index} основная причина зловердности - это библиотеки: {libs}")


test_df = pd.read_csv('test.tsv', sep='\t')
test_df = add_cols(test_df)

with open('model.pkl', 'rb') as file:
    model = pickle.load(file)

pred = model.predict()
create_prediction_txt(pred)
create_explain_txt(model, test_df, pred)
